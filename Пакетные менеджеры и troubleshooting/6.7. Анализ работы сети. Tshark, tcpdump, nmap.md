
Идея стека сетевых протоколов в том, чтобы все задачи разделить по уровням, и те инструменты, которые занимаются задачами одного уровня, о других уровнях не думают. Как вы знаете, в _TCP/IP_ таких уровней четыре:

1. канальный или уровень сетевого интерфейса,
2. сетевой,
3. транспортный,
4. прикладной.

И точно так же, как транспортный уровень не думает о том, как маршрутизировать трафик, так и физический уровень не задумывается о том, как в браузере правильно картинки с котиками показывать.

И когда мы анализируем проблемы с сетью, мы тоже делаем это по уровням:

- Физический уровень — не повредились ли где-то провода, не забит ли канал _Wi-Fi_.
- Сетевой — всё ли правильно с адресами и маршрутизацией, туда ли, куда надо, идёт траффик.
- Транспортный — открыты ли порты.
- Прикладной — правильно ли приложение работает с сетью.

## **Анализ портов. Nmap**


Самый популярный инструмент для проверки портов — это `nmap`. У него есть и другие функции, но чаще всего мы используем именно базовую способность этой утилиты. Если запустить команду без всяких флагов, то она выдаст список портов, которые открыты на указанном адресе. Например:

# nmap 8.8.8.8
Starting Nmap 7.70 ( https://nmap.org ) at 2020-11-20 12:51 MSK
Nmap scan report for dns.google (8.8.8.8)
Host is up (0.043s latency).
Not shown: 998 filtered ports
PORT    STATE SERVICE
53/tcp  open  domain
443/tcp open  https

Nmap done: 1 IP address (1 host up) scanned in 19.26 seconds

Мы видим, что в данном случае открыто два порта — 53 и 443.

Просто, как вы уже знаете, есть список общепринятых портов для служб — _DNS_ слушает 53-й, _HTTP_ — 80-й, _NTP_ — 123-й, _Doom_ — 666-й и так далее. Вот именно из этого списка исходит _nmap_, когда пишет что-то в графу _SERVICE_. То есть если вы повесите _DNS_ на 80 порт, а _HTTP_ — на 53, _nmap_ всё ещё будет писать 53-_domain_, 80-_http_.


## **Перехват трафика. Tcpdump и tshark**

Например, чтобы проверить, в каком месте потерялся трафик, удобно использовать _tcpdump_.

_Tcpdump_ — этот утилита, которая показывает все пакеты на выбранном сетевом интерфейсе.

**Сетевой интерфейс** — это обычно сетевая карта, физическая или логическая, или порт. Посмотреть сетевые интерфейсы вы можете, например, в выводе команды _ifconfig_.

Ещё _tshark_ славится возможностью отфильтрованный по каким-то параметрам трафик записать в файл, который вы сможете потом анализировать, как анализировали бы логи. Для этого используется флаг `-r`. Например, в нашем случае можно было бы поступить так:

tshark -R "ip.addr == 2.2.2.2" -r /tmp/rdpconnection.log

И потом, не торопясь, исследовать этот файл. Как и для _tcpdump_, для _tshark_ существует ещё множество фильтров и опций, и каким из этих снифферов пользоваться — решать только вам.

## **Список команд**

|   |   |
|---|---|
|nmap 8.8.8.8|Посмотреть все открытые порты хоста (в данном случае — хоста 8.8.8.8)|
|nmap -p443 yandex.ru|Посмотреть, открыт ли порт у хоста (в данном случае — открыт ли порт 443 у yandex.ru)|
|nmap 192.168.0.*<br><br>nmap 192.168.0.1/24<br><br>nmap 192.168.0.1-192.168.0.255|Посмотреть открытые порты на диапазоне адресов|
|nmap -sV scanme.nmap.org|Посмотреть подробную информацию о системе хоста и о службах на открытых портах|
|tcpdump -pni eth1|Посмотреть трафик на интерфейсе (в данном случае — интерфейсе eth1)|
|tcpdump -pni eth1 port 3389|Посмотреть трафик на интерфейсе на конкретном порту (в данном случае — на порту 3389 на интерфейсе eth1)|
|tcpdump -pni eth0 icmp|Посмотреть трафик по протоколу icmp (пакеты команды ping)|
|tshark -D|Посмотреть список интерфейсов|
|tshark -i eth1|Посмотреть трафик на интерфейсе (в данном случае — интерфейсе eth1)|
|tshark -i eth1 host 8.8.8.8|Посмотреть трафик для хоста на интерфейсе (в данном случае — трафик хоста 8.8.8.8 на интерфейсе eth1)|
|tshark -i eth1 port 3389|Посмотреть трафик на интерфейсе на конкретном порту (в данном случае — на порту 3389 на интерфейсе eth1)|

