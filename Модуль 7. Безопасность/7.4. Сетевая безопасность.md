
## **Порты и протоколы**

Например, то, что нам, может, и хотелось бы, как инженерам по безопасности, закрыть вообще все порты. Но если у нас веб-сервер работает, то без открытых портов 80 и 443 он пользователю сайт не покажет. И если мы 80 и 443 закроем вместе с остальными, то работа веб-сервера, фактически, встанет. Об этом мы с вами уже говорили в прошлом модуле — что надо закрывать порты, которые не используются, и открывать те, которые используются, фаерволом.

И в прошлых юнитах начали разбирать закрытие доступа для всех _IP_-адресов, кроме одного. Вспомним, как это делается:

iptables -A INPUT -p tcp --dport 22 -s 2.2.2.2 -j ACCEPT
iptables -A INPUT -p tcp --dport 22 -j REJECT

Таким же образом можно разрешить доступ нескольким _IP_-адресам и запретить всем остальным.

Вот, например, 22 порт — это порт _SSH_, как мы уже знаем. А по какому протоколу _SSH_ работает? Вообще, по _TCP_. То есть, казалось бы, _UDP_-порт 22 мы можем смело закрывать.

В целом, это правда, но, например, есть протокол _FASP_, который использует _SSH_ по 22 _UDP_-порту. Если вдруг когда-то вы с ним встретитесь, то, скорее всего, не сразу дойдёте до мысли, что он использует _UDP-SSH_. В требованиях, скорее всего, будет просто указан _SSH_, без уточнений, и вы будете биться об эту проблему, пока не нагуглите специфику.

Но если с _UDP_ всё неоднозначно, то проще с _ICMP_. _ICMP_ — это протокол пинга, утилиты, проверяющей, реагирует ли вообще сервер на внешние раздражители.

Если сервер отвечает на пинг, его удобно проверять что вам, что потенциальным злоумышленникам. В том числе проверять все открытые порты. Это вроде того, что мы детей учим «если в дверь позвонят, не говори, что ты дома один». Тут хорошей практикой считается закрыть _ICMP_ для главных боевых серверов, и оставить открытым для любых тестовых и внутренних.

Запретить пинговать свой сервер при помощи _iptables_ можно следующим образом:

iptables -I INPUT -p icmp --icmp-type 8 -j DROP

## **NAT**

Хотя фаервол — это всегда первая и обязательная линия обороны, есть и другие сетевые средства, помогающие сделать инфраструктуру более безопасной, например, **NAT**.

## ***Пример***

Давайте представим, что у нас есть сервер (например, веб-сервер, раз уж мы на их примере порты разбирали), который находится за NAT в локальной сети предприятия. Внешний адрес у роутера будет 2.2.2.2, внутренний, без изысков, — 192.168.0.1, а адрес веб-сервера — 192.168.0.76, например.

![](https://lms-cdn.skillfactory.ru/assets/courseware/v1/14eb0f673075948171ecf28d37e51ef1/asset-v1:SkillFactory+ADMIN+2020+type@asset+block/ADMIN_m7_u4.png)

_Почему на всех схемах компьютеры до сих пор выглядят как IBM максимум 98 года выпуска с кнопкой включения на мониторе, науке неизвестно, но не будем нарушать традиции._

На нашем веб-сервере лежит сайт, например _mysite.com_. Если мы спросим у любой _DNS_-службы, она скажет: _mysite.com_ лежит на _IP_-адресе 2.2.2.2.

Когда запрос для сайта _mysite.com_ приходит на адрес 2.2.2.2, то есть на наш роутер, роутер смотрит: ага, 443 порт! Он у меня проброшен (или, официальным языком, _перенаправлен_) на тот же самый 443 порт сервера 192.168.0.76 и, особо не вникая, передаёт пакеты запроса на наш веб-сервер, который запрос обрабатывает как положено веб-серверу, и шлёт нужные данные в обратную сторону.

Все это вы знаете из главы про сети: как подменяются _IP_-адреса при прохождении через _NAT_ и так далее. Поговорим об этом с точки зрения безопасности.

Вот веб-серверу на нашем сервере эта конструкция безопасности не добавила никак: весь трафик 443 порта по-прежнему приходит прямо к нему. Если кто-то взламывает сайт, роутер его никак от этого не защитит.

Но при этом, например, служба _DNS_, которая работает только на получение, а не как _DNS_-сервер, не нуждается в проброшенном 53 порту, а значит, снаружи по 53 порту наш сервер не виден. И по всем остальным, которые не нужны для доступа из интернета, — тоже.

Получается, что **NAT безопасности добавляет**, **но не является каким-то гарантом**.

А какие ещё моменты, связанные с _NAT_’ом, могут прибавить сети безопасности?

Во-первых, конечно, не используем адресацию 192.168.0.0/24. Всё по той же причине — это самый ожидаемый вариант. Лучше взять что-то из адресов 172.16.х.х-172.30.х.х или вообще 10.х.х.х — тут уже вариантов гораздо больше. Их, конечно, тоже можно заскриптовать, но наша задача — не добиться абсолютной безопасности, как мы уже говорили, а постараться применять максимальное количество базовых предосторожностей.

А ещё, если в сети нет сервисов, которые должны быть доступны всему интернету, для доступа к ним лучше использовать _VPN_.

## **VPN**

**VPN** (англ. _Virtual Private Network_, то есть «виртуальная частная сеть») — обобщённое название технологий, позволяющих обеспечить одно или несколько сетевых соединений (логическую сеть) поверх другой сети (например, сети Интернет).

## **Как это вообще работает?**

_VPN_-клиент на компьютере связывается с _VPN_-сервером по тому адресу, который вы ему указали. Если логин-пароль (и иногда еще и ключ) правильные, то _VPN_-сервер подключает _VPN_-клиент, то есть разрешает использовать себя как шлюз, но весь трафик между ними начинает шифроваться.

Когда вы подключаетесь по _VPN_ куда-либо, у вас появляется дополнительный маршрут. Шлюз в этом маршруте — _VPN_-сервер. А вот какая сеть будет доступна через этот шлюз, в каждом конкретном случае разная.

Часто это «серая» сеть предприятия, которая без _VPN_ просто недоступна. Но это может быть, например, и вообще весь трафик, если _VPN_ не корпоративный, а купленный вами лично.

Иногда _VPN_-клиенты, особенно на _Windows_, пытаются автоматически весь трафик пропускать через _VPN_-сервер, даже запросы в Яндекс — и это не слишком удобно, когда _VPN_ корпоративный, потому что скорость через _VPN_ всегда медленнее: во-первых, из-за того, что шлюз находится в другом городе, а то и стране, а во-вторых из-за шифрования.

Шифрованный пакет всегда весит больше, чем нешифрованный, а значит, шифрованные данные передаются медленнее. Это ещё один пример того, что безопасность и доступность всегда должны находиться в балансе.

## **OpenVPN**

Протоколов для _VPN_-соединения много, но один из самых распространённых для _Linux_ — это _OpenVPN_.

Устанавливается _OpenVPN_, как и все остальные пакеты, при помощи _apt-get_:

apt-get install openvpn

Дальше, в случае, если у вас есть конфигурационный файл от провайдера _VPN_ вида ._ovpn_, то подключение происходит предельно просто — запуском _OpenVPN_ с этим файлом:

openvpn example.ovpn

На самом деле, _OpenVPN_ — не самая безопасная система, и зачастую сейчас корпорации используют какие-то платные _VPN_-сервера и соответствующие им _VPN_-клиенты, такие, например, как _[VPN от Cisco](https://www.cisco.com/c/en/us/products/security/anyconnect-secure-mobility-client/index.html)_.

Каждый из таких серверов, конечно, настраивается индивидуально, а у клиентов обычно необходимо указать сервер, логин и пароль (и иногда — сертификат). Вне зависимости от того, какой именно у вас _VPN-_клиент, все эти данные обычно можно указать в конфигах _VPN-_службы.

## **DMZ**

Вообще, DMZ — это от английского _demilitarized zone_ — то есть демилитаризованная зона. В реальном мире это территории, где запрещено находиться вооружённым силам. А в мире компьютерных сетей это такая специальная зона для всех серверов, которые каким-то образом должны отдавать информацию в Интернет.

Помните, мы говорили, что если есть веб-сервер, то он должен принимать запросы от пользователей из Интернета, иначе зачем он вообще такой нужен? А раз он может принимать запросы, значит, его могут взломать, и, взломав один сервер, проникнут в локальную сеть.

Вот именно для того, чтобы этого не происходило, и создают _DMZ_-сети. Такая сеть отделена от всей остальной локальной сети и, как правило, находится за отдельным фаерволом. В _DMZ_-сети находится всё, что принимает запросы извне — веб-серверы, почта, _DNS_-сервера и так далее. Всё, что уязвимо для атак. Но, так как сети отделены, то взлом сервера в _DMZ_-сети не даст хакеру доступ к сети локальной.

![](https://lms-cdn.skillfactory.ru/assets/courseware/v1/a389ea06184ecb0b4ad6a0939c6b0a0d/asset-v1:SkillFactory+ADMIN+2020+type@asset+block/ADMIN_m7_u4_2.png)

  
Источник: [ionos.com](https://www.ionos.com/digitalguide/fileadmin/DigitalGuide/Screenshots/dmz-network-diagram-2.png)

И, конечно, доступа с серверов из _DMZ_-зоны в локальную сеть быть не должно, иначе это нивелирует сам концепт _DMZ_-сетей.